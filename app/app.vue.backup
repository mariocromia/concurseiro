<template>
  <div>
    <ClientOnly>
      <ModernNav v-if="showNav" />
      <GlobalSearchBar
        v-if="showNav && showSearchBar"
        v-model="searchQuery"
        :placeholder="searchPlaceholder"
        :show-advanced="searchConfig.showAdvanced"
        :show-quick-results="searchConfig.showQuickResults"
        @search="handleSearch"
        @input="handleSearchInput"
      >
        <!-- Filtros personalizados por p√°gina -->
        <template #filters>
          <slot name="search-filters" />
        </template>

        <!-- Op√ß√µes avan√ßadas por p√°gina -->
        <template #advanced>
          <slot name="search-advanced" />
        </template>

        <!-- Resultados r√°pidos por p√°gina -->
        <template #results="{ query }">
          <slot name="search-results" :query="query" />
        </template>
      </GlobalSearchBar>
      <FloatingTimer />
      <WhatsAppButton />
    </ClientOnly>
    <NuxtPage />
  </div>
</template>

<script setup lang="ts">
import { ref, watch, computed } from 'vue'
import { useRoute, useRouter } from 'vue-router'

const route = useRoute()
const router = useRouter()
const showNav = ref(true)
const showSearchBar = ref(true)
const searchQuery = ref('')

// Configura√ß√£o de busca por p√°gina
const searchConfig = computed(() => {
  const path = route.path

  // Configura√ß√µes padr√£o
  const configs: Record<string, any> = {
    '/dashboard': {
      placeholder: 'Buscar mat√©rias, estat√≠sticas...',
      showAdvanced: false,
      showQuickResults: false
    },
    '/materias': {
      placeholder: 'Buscar mat√©rias...',
      showAdvanced: true,
      showQuickResults: true
    },
    '/flashcards': {
      placeholder: 'Buscar flashcards...',
      showAdvanced: true,
      showQuickResults: true
    },
    '/caderno': {
      placeholder: 'Buscar anota√ß√µes...',
      showAdvanced: false,
      showQuickResults: true
    },
    '/calendar': {
      placeholder: 'Buscar agendamentos...',
      showAdvanced: true,
      showQuickResults: false
    },
    '/study': {
      placeholder: 'Buscar conte√∫do...',
      showAdvanced: false,
      showQuickResults: false
    }
  }

  return configs[path] || {
    placeholder: 'Buscar...',
    showAdvanced: false,
    showQuickResults: false
  }
})

const searchPlaceholder = computed(() => searchConfig.value.placeholder)

// Hide nav on login/register pages
watch(() => route.path, (newPath) => {
  const hiddenPaths = ['/login', '/register', '/forgot-password', '/confirm']
  showNav.value = !hiddenPaths.includes(newPath)

  // Tamb√©m esconder barra de busca em algumas p√°ginas
  const noSearchPaths = ['/login', '/register', '/forgot-password', '/confirm', '/study']
  showSearchBar.value = !noSearchPaths.includes(newPath)
}, { immediate: true })

// Handlers de busca
const handleSearch = (query: string) => {
  console.log('üîç Busca realizada:', query)
  // Emitir evento global ou usar composable de busca
  window.dispatchEvent(new CustomEvent('global-search', { detail: { query } }))
}

const handleSearchInput = (query: string) => {
  // Busca em tempo real (debounced)
  window.dispatchEvent(new CustomEvent('global-search-input', { detail: { query } }))
}
</script>
